<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>⚡SmartMeter Chatbot</title>
    <meta name="description"
        content="A unified chatbot interface to analyze Excel files, query MySQL databases, and generate predictive insights using natural language.">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Ribeye&display=swap" rel="stylesheet" />
    <link rel="icon" href="images/pat.jpg" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}" />
    <link rel="icon" href="{{ url_for('static', filename='img40.jpg')}}">
</head>
<body>
    <div class="container">
        <h1>⚡SmartMeter Chatbot</h1>
        <a class="uniqueof" href="{{ url_for('dashboard') }}">
        <button class="c-button c-button--gooey"> Go to Dashboard
        <div class="c-button__blobs">
        <div></div>
        <div></div>
        <div></div>
        </div>
        </button></a>
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="display: block; height: 0; width: 0;">
        <defs>
            <filter id="goo">
            <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur"></feGaussianBlur>
            <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo"></feColorMatrix>
            <feBlend in="SourceGraphic" in2="goo"></feBlend>
            </filter>
        </defs>
        </svg>
        <p class="description">Analyze Excel files, query databases, and get predictive insights through natural
            language conversations</p>

        <div class="tabs">
            <div class="tab active" onclick="showTab('excel')">
                <div class="tab-icon excel-icon"><i class="fas fa-file-excel"></i></div>
                <div class="tab-text">
                    <span>Excel Analysis</span>
                    
                </div>
            </div>
            <div class="tab" onclick="showTab('db')">
                <div class="tab-icon db-icon"><i class="fas fa-database"></i></div>
                <div class="tab-text">
                    <span>Database Query</span>
                    
                </div>
            </div>
            <div class="tab" onclick="showTab('predictive')">
                <div class="tab-icon predict-icon"><i class="fas fa-chart-line"></i></div>
                <div class="tab-text">
                    <span>Predictive Analysis</span>
                    
                </div>
            </div>
        </div>

        <!-- Excel Analysis -->
        <div id="excel" class="tab-content active">
            <div class="chat-box" id="excel-chat">
                <p>Welcome to Excel Analysis mode!</p>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <label id="upload-box" for="fileInput" class="upload-box">
                    <i class="fas fa-cloud-upload-alt upload-iconed"></i>
                    <strong style="color: white">Upload Excel File</strong>
                    <p style="font-size: 12px;">Drag and drop your .xlsx or .csv file here, or click to
                        browse</p>
                </label>
                <input type="file" id="fileInput" name="file" accept=".xlsx,.csv" style="display: none" />
            </form>
            <div class="input-bar">
                <input type="text" id="excel-question" placeholder="Ask a question about your Excel data..." />
                <button type="button" onclick="sendExcelQuestion()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Database Query -->
        <div id="db" class="tab-content">
            <div class="chat-box" id="db-chat">
                <p>Welcome to Database Query mode!</p>
            </div>
            <div class="input-bar">
                <input type="text" id="db-question" placeholder="Ask a question about your database..." />
                <button type="button" onclick="sendDbQuestion()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Predictive Analysis -->
        <div id="predictive" class="tab-content">
            <div class="chat-box" id="predictive-chat">
                <p>Welcome to Predictive Analysis mode!</p>
            </div>
            <form id="predictiveForm" enctype="multipart/form-data">
                <label id="predictive-upload-box" for="predictive-fileInput" class="upload-box">
                    <i class="fas fa-cloud-upload-alt upload-iconed"></i>
                    <strong style="color: white">Upload Excel File</strong>
                    <p style="font-size: 12px;">Drag and drop your .xlsx or .csv file here, or click to
                        browse</p>
                </label>
                <input type="file" id="predictive-fileInput" name="file" accept=".xlsx,.csv" style="display: none" />
            </form>
            <div class="input-bar">
                <input type="text" id="predictive-question"
                    placeholder="Ask a question about your data for predictions..." />
                <button type="button" onclick="sendPredictiveQuestion()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>


    <script>
    
       

    function addBotMessage(message) {
        const chatBox = document.querySelector("#db .chat-box");
        const bot = document.createElement("p");
        bot.textContent = message;
        chatBox.appendChild(bot);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    let uploadedExcelFile = "";

    function showTab(id) {
        document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(tc => tc.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        event.currentTarget.classList.add("active");
    }

    function showSuccess(tab) {
        const box = document.querySelector(`#${tab}-chat`);
        if (!box) return;
        const msg = document.createElement("div");
        msg.className = "success-msg";
        msg.innerHTML = `<strong>✅ File uploaded successfully!</strong><div class="success-bar"></div>`;
        box.appendChild(msg);
        setTimeout(() => {
            msg.style.animation = "fadeOut 0.6s ease forwards";
            setTimeout(() => msg.remove(), 600);
        }, 5000);
    }

    function showError(tab, message) {
        const box = document.querySelector(`#${tab}-chat`);
        if (!box) return;
        const msg = document.createElement("div");
        msg.className = "error-msg";
        msg.innerHTML = `<strong>${message}</strong><div class="error-bar"></div>`;
        box.appendChild(msg);
        setTimeout(() => {
            msg.style.animation = "fadeOut 0.6s ease forwards";
            setTimeout(() => msg.remove(), 600);
        }, 5000);
    }

    // Excel File Upload
    document.getElementById("fileInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        fetch("/upload", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.filename) {
                uploadedExcelFile = data.filename;
                const uploadBox = document.getElementById("upload-box");
                uploadBox.style.opacity = "0";
                setTimeout(() => uploadBox.style.display = "none", 400);
                showSuccess("excel");
            }
        })
        .catch(err => console.error("Upload error:", err));
    });

    // Predictive File Upload
    document.getElementById("predictive-fileInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("file", file);
        fetch("/upload", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.filename) {
                uploadedExcelFile = data.filename;
                const uploadBox = document.getElementById("predictive-upload-box");
                uploadBox.style.opacity = "0";
                setTimeout(() => uploadBox.style.display = "none", 400);
                showSuccess("predictive");
            }
        })
        .catch(err => console.error("Upload error:", err));
    });

    // Excel Query
    function sendExcelQuestion() {
        const input = document.getElementById("excel-question");
        const msg = input.value.trim();
        if (!msg || !uploadedExcelFile) return;
        const chatBox = document.getElementById("excel-chat");
        const user = document.createElement("p");
        user.className = "user";
        user.textContent = msg;
        chatBox.appendChild(user);
        fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                filename: uploadedExcelFile,
                question: msg
            })
        })
        .then(res => res.json())
        .then(data => {
            const bot = document.createElement("p");
            bot.textContent = (data.answer || "Something went wrong.");
            chatBox.appendChild(bot);
            chatBox.scrollTop = chatBox.scrollHeight;
        });
        input.value = "";
    }

    // Predictive Query
    function sendPredictiveQuestion() {
        const input = document.getElementById("predictive-question");
        const msg = input.value.trim();
        if (!msg || !uploadedExcelFile) return;
        const chatBox = document.getElementById("predictive-chat");
        const user = document.createElement("p");
        user.className = "user";
        user.textContent = msg;
        chatBox.appendChild(user);
        fetch("/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                filename: uploadedExcelFile,
                question: msg
            })
        })
        .then(res => res.json())
        .then(data => {
            const bot = document.createElement("p");
            bot.textContent = (data.result || "Something went wrong.");
            chatBox.appendChild(bot);
            chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(err => {
            const error = document.createElement("p");
            error.textContent = "⚠️ Failed to fetch prediction.";
            chatBox.appendChild(error);
        });
        input.value = "";
    }

    // Database Query - NOW WORKS WITHOUT FILE UPLOAD
    function sendDbQuestion() {
        const input = document.getElementById("db-question");
        const msg = input.value.trim();
        if (!msg) return;  // Removed the uploadedDbTable check
        
        const chatBox = document.getElementById("db-chat");
        const user = document.createElement("p");
        user.className = "user";
        user.textContent = msg;
        chatBox.appendChild(user);
        
        fetch("/query_db", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                question: msg  // Only sending question, no table_name
            })
        })
        .then(res => res.json())
        .then(data => {
            const bot = document.createElement("p");
            if (data.results && data.columns) {
                let tableHtml = '<table style="width:100%; border-collapse: collapse; margin-top: 10px;">';
                tableHtml += '<tr>';
                data.columns.forEach(col => {
                    tableHtml += `<th style="border: 1px solid #ccc; padding: 8px;">${col}</th>`;
                });
                tableHtml += '</tr>';
                data.results.forEach(row => {
                    tableHtml += '<tr>';
                    row.forEach(cell => {
                        tableHtml += `<td style="border: 1px solid #ccc; padding: 8px;">${cell}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</table>';
                bot.innerHTML = `${tableHtml}`;
            } else {
                bot.textContent = (data.error || data.message || "Something went wrong.");
            }
            chatBox.appendChild(bot);
            chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(err => {
            const error = document.createElement("p");
            error.textContent = "⚠️ Failed to query database.";
            chatBox.appendChild(error);
        });
        input.value = "";
    }

    // Allow Enter key to send
    document.getElementById("excel-question").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendExcelQuestion();
        }
    });

    document.getElementById("predictive-question").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendPredictiveQuestion();
        }
    });

    document.getElementById("db-question").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendDbQuestion();
        }
    });

    // Reset DB chat memory on page load
    fetch('/reset_db_chat', { method: 'POST' });

</script>


</body>
</html>