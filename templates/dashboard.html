<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>⚡SmartMeter Monitoring Dashboard</title>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="icon" href="{{ url_for('static', filename='img40.jpg')}}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <style>

    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Poppins', sans-serif;
      letter-spacing: .5px;
      background: #070013;
    }
    .tab-content h2{
        color:white;

    }
    body {
      display: flex;
      overflow: hidden;
    }
    

    
    .sidebar {
  width: 270px;
  background: #000000;
  color: #fff;
  padding: 24px 16px;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  gap: 16px;
  box-shadow: 2px 0 8px #130C20;
}

.sidebar .logo {
  font-size: 1.4rem;
  font-weight: 600;
  color: #ffffff;
}

.sidebar h2 {
  font-size: 1rem;
  color: #9ca3af;
  margin: 12px 0 8px;
}

.sidebar .tab-button {
  display: flex;
  align-items: center;
  gap: 10px;
  background: transparent;
  border: none;
  color: #e5e7eb;
  font-size: 0.95rem;
  text-align: left;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.sidebar .tab-button:hover {
  background: #374151;
}

.sidebar .tab-button.active {
  background: #130C20;
  color: #ffffff;
}





    
    .main-content {
      padding: 20px;
      height: 100vh;
      overflow-y: auto;
      width: calc(100% - 220px);
      scroll-behavior: smooth;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .dashboard-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .card {
        flex: 1 1 200px;
        padding: 20px;
        background: #000000;
        border: 1.5px solid #190048;
        color:white;
        border-radius: 12px;
        box-shadow: 0 2px 6px #130C20;
        text-align: center;
        transition: transform 0.2s ease;
        }
    .card strong {
        display: block;
        font-size: 1.6rem;
        color: #ffffff;
    }
    .card::before {
        content: attr(data-label);
        display: block;
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .card:hover {
      transform: scale(1.02);
    }
    .chart-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .chart-container {
      flex: 1 1 calc(50% - 20px);
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px #130C20;
      border: 1.5px solid #190048;
      padding: 16px;
      transition: box-shadow 0.3s ease;
    }
    .chart-container:hover {
      box-shadow: 0 6px 18px #130C20;
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    h2 {
      margin-top: 0;
      font-size: 1.8rem;
      color: #111827;
    }
    @media screen and (max-width: 768px) {
      .chart-container {
        flex: 1 1 100%;
      }
      .dashboard-cards {
        flex-direction: column;
      }
    }
    .chart-container {
  background-color: #000;
  padding: 1rem;
  border-radius: 12px;
}

  </style>
</head>
<body>

<div class="sidebar">
  <div class="logo">⚡ SmartMeter</div>
  <h2>Reports & Analytics</h2>
  <button class="tab-button active" onclick="openTab('dashboard')">
    <i data-feather="activity"></i> Dashboard
  </button>
  <button class="tab-button" onclick="openTab('airflow')">
    <i data-feather="wind"></i> Airflow Meter
  </button>
  <button class="tab-button" onclick="openTab('energy')">
    <i data-feather="zap"></i> Energy Meter
  </button>
  <button class="tab-button" onclick="openTab('temperature')">
    <i data-feather="thermometer"></i> Temperature Meter
  </button>
  <button class="tab-button" onclick="openTab('pressure')">
    <i data-feather="trending-up"></i> Pressure Meter
  </button>
  <button class="tab-button" onclick="openTab('water')">
    <i data-feather="droplet"></i> Water Meter
  </button>
  <button class="tab-button" onclick="window.location.href='/chatbot'">
  <i data-feather="message-circle"></i> Chatbot
</button>
</div>




<div class="main-content">
  <div id="dashboard" class="tab-content active">
    <h2>Overview Dashboard</h2>
    <div class="dashboard-cards">
  <div class="card" data-label="Total Airflow"><strong>18650 CFM</strong></div>
  <div class="card" data-label="Total Energy"><strong>1120 kWh</strong></div>
  <div class="card" data-label="Avg Temp"><strong>56.2°C</strong></div>
  <div class="card" data-label="Alerts"><strong>12 Critical</strong></div>
</div>

    <div class="chart-row">
      <div class="chart-container"><canvas id="dashboardLine"></canvas></div>
      <div class="chart-container"><canvas id="dashboardBar"></canvas></div>
    </div>
  </div>

  <div id="airflow" class="tab-content">
    <h2>Airflow Meter</h2>
    <div class="chart-row">
      <div class="chart-container"><canvas id="airflowLine"></canvas></div>
      <div class="chart-container"><canvas id="airflowBar"></canvas></div>
      <div class="chart-container"><canvas id="airflowDonut"></canvas></div>
      <div class="chart-container"><canvas id="airflowAvgLine"></canvas></div>
    </div>
  </div>

  <div id="energy" class="tab-content">
    <h2>Energy Meter</h2>
    <div class="chart-row">
      <div class="chart-container"><canvas id="energyLine"></canvas></div>
      <div class="chart-container"><canvas id="energyBar"></canvas></div>
      <div class="chart-container"><canvas id="energyDonut"></canvas></div>
      <div class="chart-container"><canvas id="energyCumLine"></canvas></div>
    </div>
  </div>

  <div id="temperature" class="tab-content">
    <h2>Temperature Meter</h2>
    <div class="chart-row">
      <div class="chart-container"><canvas id="tempLineLocation"></canvas></div>
      <div class="chart-container"><canvas id="tempBarLocation"></canvas></div>
      <div class="chart-container"><canvas id="tempDonut"></canvas></div>
      <div class="chart-container"><canvas id="tempBarStatus"></canvas></div>
    </div>
  </div>

  <div id="pressure" class="tab-content">
    <h2>Pressure Meter</h2>
    <div class="chart-row">
      <div class="chart-container"><canvas id="pressureLine"></canvas></div>
      <div class="chart-container"><canvas id="pressureBar"></canvas></div>
      <div class="chart-container"><canvas id="pressureDonut"></canvas></div>
      <div class="chart-container"><canvas id="pressureScatter"></canvas></div>
    </div>
  </div>

  <div id="water" class="tab-content">
    <h2>Water Meter</h2>
    <div class="chart-row">
      <div class="chart-container"><canvas id="waterScatter"></canvas></div>
      <div class="chart-container"><canvas id="waterDonut"></canvas></div>
      <div class="chart-container"><canvas id="waterBar"></canvas></div>
      <div class="chart-container"><canvas id="waterSimLine"></canvas></div>
    </div>
  </div>
</div>

<!-- Only keep one version of each library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
  const client = supabase.createClient(
    'https://ybqenffxafjvrkcxdnrz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlicWVuZmZ4YWZqdnJrY3hkbnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMTQyNzUsImV4cCI6MjA2NzU5MDI3NX0.0Yb45LKjz_H63ZSiAg7cfzprBq-NEu54-v903h_-A54'
  );

  function openTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.querySelector(`.tab-button[onclick*="${tabId}"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
  }

  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.responsive = true;
  Chart.defaults.color = '#ffffff';
  Chart.defaults.plugins.legend.labels.color = '#ffffff';
  Chart.defaults.scales = {
    x: {
      ticks: { color: '#ffffff' },
      grid: { color: '#444444' }
    },
    y: {
      ticks: { color: '#ffffff' },
      grid: { color: '#444444' }
    }
  };

  function plot(id, config) {
    const el = document.getElementById(id);
    if (el && config?.data?.datasets?.length > 0) {
      if (!config.options) config.options = {};
      config.options.plugins = config.options.plugins || {};
      config.options.plugins.legend = config.options.plugins.legend || {};
      config.options.plugins.legend.labels = { color: '#ffffff' };
      config.options.scales = Chart.defaults.scales;
      config.options.backgroundColor = '#000000';
      new Chart(el, config);
    }
  }

  async function fetchData(table, cols) {
    const { data, error } = await client.from(table).select(cols).order('timestamp', { ascending: true });
    if (error) console.error(`${table} fetch error:`, error);
    return data || [];
  }

  function chartLine(label, data, key) {
    return {
      type: 'line',
      data: {
        labels: data.map(d => d.timestamp),
        datasets: [{
          label,
          data: data.map(d => d[key]),
          borderColor: '#3b82f6',
          backgroundColor: 'transparent',
          tension: 0.3
        }]
      }
    };
  }

  function chartBar(label, data, key) {
    return {
      type: 'bar',
      data: {
        labels: data.map(d => d.timestamp || 'N/A'),
        datasets: [{
          label,
          data: data.map(d => d[key]),
          backgroundColor: '#10b981'
        }]
      }
    };
  }

  function chartDonut(label, obj) {
    return {
      type: 'doughnut',
      data: {
        labels: Object.keys(obj),
        datasets: [{
          label,
          data: Object.values(obj),
          backgroundColor: ['#f43f5e', '#fbbf24', '#3b82f6', '#10b981']
        }]
      }
    };
  }

  function chartScatter(label, data, xKey, yKey) {
    return {
      type: 'scatter',
      data: {
        datasets: [{
          label,
          data: data.map(d => ({ x: d[xKey], y: d[yKey] })),
          backgroundColor: '#f97316'
        }]
      }
    };
  }

  function avg(arr, key) {
    return arr.length ? (arr.reduce((a, b) => a + (b[key] || 0), 0) / arr.length).toFixed(1) : 0;
  }

  function cumulative(data, key) {
    let sum = 0;
    return data.map((d, i) => ({ timestamp: d.timestamp || i, value: sum += (d[key] || 0) }));
  }

  async function updateDashboardCards() {
    const [airflow, energy, temperature, criticalTemp] = await Promise.all([
      fetchData('airflow_meter_data', 'airflow_cfm'),
      fetchData('energy_meter_data', 'energy_kwh'),
      fetchData('temperature_meter_data', 'temperature'),
      client.from('temperature_meter_data').select('status').eq('status', 'Critical')
    ]);

    document.querySelector(".card:nth-child(1) strong").innerText = `${airflow.reduce((sum, r) => sum + (r.airflow_cfm || 0), 0).toFixed(0)} CFM`;
    document.querySelector(".card:nth-child(2) strong").innerText = `${energy.reduce((sum, r) => sum + (r.energy_kwh || 0), 0).toFixed(1)} kWh`;
    document.querySelector(".card:nth-child(3) strong").innerText = `${avg(temperature, 'temperature')}°C`;
    document.querySelector(".card:nth-child(4) strong").innerText = `${criticalTemp?.data?.length || 0} Critical`;
  }

  async function drawCharts() {
    const airflow = await fetchData('airflow_meter_data', 'timestamp, airflow_cfm');
    const energy = await fetchData('energy_meter_data', 'timestamp, energy_kwh');
    const temperature = await fetchData('temperature_meter_data', 'timestamp, temperature, location');
    const pressure = await fetchData('pressure_meter_data', 'timestamp, pressure_bar, x, y');
    const water = await client.from('water_meter_data').select('x, y, last_updated');

    plot('dashboardLine', chartLine('Airflow (CFM)', airflow, 'airflow_cfm'));
    plot('dashboardBar', {
      type: 'bar',
      data: {
        labels: ['Energy', 'Temp', 'Pressure'],
        datasets: [{
          label: 'Average Value',
          data: [
            avg(energy, 'energy_kwh'),
            avg(temperature, 'temperature'),
            avg(pressure, 'pressure_bar'),
          ],
          backgroundColor: ['#22c55e', '#f97316', '#6366f1']
        }]
      }
    });

    plot('airflowLine', chartLine('CFM Flow', airflow, 'airflow_cfm'));
    plot('airflowBar', chartBar('CFM Distribution', airflow.slice(0, 10), 'airflow_cfm'));
    plot('airflowDonut', chartLine('Recent Airflow (20)', airflow.slice(-20), 'airflow_cfm'));
    plot('airflowAvgLine', chartLine('Avg CFM Trend', airflow.slice(10, 30), 'airflow_cfm'));

    plot('energyLine', chartLine('Energy Usage', energy, 'energy_kwh'));
    plot('energyBar', chartBar('Energy Comparison', energy.slice(0, 10), 'energy_kwh'));
    plot('energyDonut', chartBar('Cumulative Energy Bar', cumulative(energy, 'energy_kwh'), 'value'));
    plot('energyCumLine', chartLine('Cumulative Energy', cumulative(energy, 'energy_kwh'), 'value'));

    plot('tempLineLocation', chartLine('Temp Change', temperature, 'temperature'));
    plot('tempBarLocation', chartBar('Temp Bars', temperature.slice(0, 10), 'temperature'));

    const grouped = {};
    temperature.forEach(row => {
      if (!grouped[row.location]) grouped[row.location] = [];
      grouped[row.location].push(row.temperature);
    });
    const locAvg = Object.keys(grouped).map(loc => ({
      label: loc,
      value: avg(grouped[loc].map(v => ({ temp: v })), 'temp')
    }));
    plot('tempDonut', {
      type: 'bar',
      data: {
        labels: locAvg.map(d => d.label),
        datasets: [{
          label: 'Avg Temp by Location',
          data: locAvg.map(d => d.value),
          backgroundColor: '#3b82f6'
        }]
      }
    });

    plot('tempBarStatus', chartBar('Temperature Status', temperature.slice(10, 20), 'temperature'));

    plot('pressureLine', chartLine('Pressure Over Time', pressure, 'pressure_bar'));
    plot('pressureBar', chartBar('Pressure Levels', pressure.slice(0, 10), 'pressure_bar'));
    plot('pressureDonut', {
      type: 'bubble',
      data: {
        datasets: pressure.slice(0, 15).map((row, i) => ({
          label: `P${i + 1}`,
          data: [{ x: row.x, y: row.y, r: (row.pressure_bar || 1) * 2 }],
          backgroundColor: '#e11d48'
        }))
      }
    });
    plot('pressureScatter', chartScatter('Pressure Pattern', pressure.slice(0, 20), 'x', 'y'));

    plot('waterScatter', chartScatter('Water Units', water.data || [], 'x', 'y'));

    const updateCounts = {};
    (water.data || []).forEach(w => {
      const year = (w.last_updated || '').slice(0, 4);
      if (year) updateCounts[year] = (updateCounts[year] || 0) + 1;
    });
    plot('waterDonut', chartDonut('Updates by Year', updateCounts));
    plot('waterBar', chartBar('Water Pressure Levels', pressure.slice(0, 10), 'pressure_bar'));
    plot('waterSimLine', chartLine('Simulated Water Flow', pressure.slice(-20), 'pressure_bar'));
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateDashboardCards();
    drawCharts();
  });
</script>

<script>
  feather.replace();
</script>





</body>
</html>
